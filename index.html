<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTML Diff & Patch Werkzeug (Optimiert)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
    
    <meta name="theme-color" content="#1e40af">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .btn {
            transition: all 0.2s ease-in-out;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #originalEditorContainer, #diffEditorContainer {
            width: 100%;
            height: 400px;
            border: 1px solid #4a5568;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        #diffEditorContainer {
            height: 600px;
        }
        #dropZone.drag-over {
            background-color: #2d3748;
            border-color: #4299e1;
        }
        #errorModal {
            transition: opacity 0.3s ease-in-out;
        }
        #errorModal.hidden {
            opacity: 0;
            pointer-events: none;
        }
        body{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;}
        input, textarea, code { user-select: text !important; -webkit-user-select: text !important; -moz-user-select: text !important; -ms-user-select: text !important; }
    </style>
  <link rel="manifest" href="./manifest.json">
<style>body{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;}</style>
<style>input, textarea, code { user-select: text !important; -webkit-user-select: text !important; -moz-user-select: text !important; -ms-user-select: text !important; }</style>
</head>
<body class="bg-gray-900 text-white p-4 sm:p-6 md:p-8">
    
    <div id="errorModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl max-w-sm w-full border border-red-700">
            <div class="p-6">
                <h3 class="text-xl font-semibold text-red-400 mb-3">Fehler</h3>
                <p id="errorMessage" class="text-gray-300 mb-6"></p>
                <button id="closeModalButton" class="w-full btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">
                    Schlie√üen
                </button>
            </div>
        </div>
    </div>

    <div id="updateSnackbar"
       class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 bg-indigo-600 text-white px-4 py-3 rounded-xl shadow-lg flex items-center space-x-3 z-50">
      <span>üîÑ Neue Version verf√ºgbar</span>
      <button id="reloadButton" class="bg-white text-indigo-700 font-semibold px-3 py-1 rounded-lg hover:bg-gray-200 transition">
        Aktualisieren
      </button>
    </div>

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-cyan-400">HTML Diff & Patch Werkzeug üöÄ</h1>
            <p class="mt-2 text-lg text-gray-400">Lade deine HTML-Datei, f√ºge die √Ñnderungsanweisungen ein und erhalte die neue Version.</p>
        </header>

        <main class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="space-y-6">
                <div id="dropZone" class="bg-gray-800/50 p-6 rounded-xl border-2 border-dashed border-gray-700 transition-colors duration-300">
                    <h2 class="text-xl font-semibold mb-3 text-cyan-300">Schritt 1: Lade deine HTML-Datei</h2>
                    <p class="text-center text-gray-400 mb-4">Datei hierher ziehen (Drag & Drop) oder ausw√§hlen:</p>
                    <input type="file" id="htmlFileInput" accept=".html" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-indigo-50 hover:file:bg-indigo-700 cursor-pointer"/>
                </div>

                <div>
                     <h2 class="text-xl font-semibold mb-2 text-cyan-300">Schritt 2: √Ñnderungsanweisungen</h2>
                     <div class="bg-gray-900 p-3 rounded-md border border-gray-600 mb-3">
                        <p class="text-sm text-gray-400">Format:</p>
                        <ul class="text-xs text-gray-500 mt-2 list-disc list-inside space-y-1">
                           <li><code>ADD &lt;Zeilennr&gt;: &lt;Inhalt&gt;</code> (F√ºgt vor der Zeile ein)</li>
                           <li><code>DEL &lt;Zeilennr&gt;</code> (L√∂scht die Zeile)</li>
                           <li><code>MOD &lt;Zeilennr&gt;: &lt;Neuer Inhalt&gt;</code> (Ersetzt die Zeile)</li>
                           <li><code># Kommentare</code> (Zeilen mit # werden ignoriert)</li>
                        </ul>
                     </div>
                     <textarea id="changesInput" rows="8" class="w-full bg-gray-900 p-3 rounded-lg border border-gray-600 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 font-mono text-sm" placeholder="z.B.&#10;DEL 15&#10;ADD 23:     <h1>Neuer Titel</h1>"></textarea>
                </div>
                
                <button id="applyButton" disabled class="w-full btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd" /></svg>
                    <span>√Ñnderungen anwenden & Vergleichen</span>
                </button>

                <div class="bg-gray-800/50 p-6 rounded-xl border border-indigo-600/50 space-y-4">
                    <h3 class="text-lg font-semibold text-indigo-300">üí° Tipp: Workflow im neuen Chat</h3>
                    <p class="text-sm text-gray-400">Wenn du in einem neuen Chat (ohne Verlauf) weiterarbeiten willst, nutze diese 3 Schritte:</p>
                    
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-gray-300">1. Mein aktueller Code:</label>
                        <p class="text-xs text-gray-500">Kopiere deinen *gesamten* Code aus dem "Original-Editor" unten und f√ºge ihn als Erstes in den neuen Chat ein.</p>
                        <button id="copyOriginalCodeButton" class="w-full btn bg-gray-700 hover:bg-gray-600 text-white text-sm font-bold py-2 px-4 rounded-lg flex items-center justify-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z" /><path d="M5 3a2 2 0 00-2 2v6a2 2 0 002 2V5h6a2 2 0 00-2-2H5z" /></svg>
                            <span>Original-Code kopieren</span>
                        </button>
                    </div>
        
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-gray-300">2. Mein Wunsch:</label>
                        <p class="text-xs text-gray-500">Beschreibe die neue Funktion, die du haben m√∂chtest (z.B. "F√ºge einen '√úber Uns'-Bereich hinzu.")</p>
                    </div>
        
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-gray-300">3. Die "Patch"-Anweisung:</label>
                        <p class="text-xs text-gray-500">Kopiere diesen Text und f√ºge ihn als Letztes ein, damit ich wei√ü, was ich tun soll.</p>
                        <div class="flex bg-gray-900 p-2 rounded-md border border-gray-600 justify-between items-center">
                            <code class="text-sm text-indigo-300" id="patchCommandText">Gib mir die ADD/DEL/MOD Anweisungen.</code>
                            <button id="copyPatchCommandButton" class="btn bg-indigo-600 hover:bg-indigo-700 p-2 rounded-md" title="Kopieren">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z" /><path d="M5 3a2 2 0 00-2 2v6a2 2 0 002 2V5h6a2 2 0 00-2-2H5z" /></svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-2 text-gray-300">Originaler Code</h3>
                    <div id="originalEditorContainer"></div>
                </div>
            </div>

            <div class="space-y-6">
                <div>
                    <h2 class="text-xl font-semibold mb-2 text-cyan-300">Schritt 3: Ergebnis (Diff-Ansicht)</h2>
                    <p class="text-sm text-gray-400 mb-4">Links das Original, rechts die √Ñnderungen. Du kannst den Code rechts bei Bedarf weiter bearbeiten.</p>
                     <button id="downloadButton" disabled class="w-full btn bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                        <span>Neue HTML-Datei herunterladen</span>
                    </button>
                </div>
                <div>
                    <div id="diffEditorContainer"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // DOM Elemente
        const fileInput = document.getElementById('htmlFileInput');
        const changesInput = document.getElementById('changesInput');
        const applyButton = document.getElementById('applyButton');
        const downloadButton = document.getElementById('downloadButton');
        const dropZone = document.getElementById('dropZone');
        const originalEditorContainer = document.getElementById('originalEditorContainer');
        const diffEditorContainer = document.getElementById('diffEditorContainer');
        
        // Error Modal Elemente
        const errorModal = document.getElementById('errorModal');
        const errorMessage = document.getElementById('errorMessage');
        const closeModalButton = document.getElementById('closeModalButton');

        // NEUE DOM Elemente f√ºr Workflow Tipp
        const copyOriginalCodeButton = document.getElementById('copyOriginalCodeButton');
        const copyPatchCommandButton = document.getElementById('copyPatchCommandButton');
        const patchCommandText = document.getElementById('patchCommandText');

        let originalContent = '';
        let originalEditor;
        let diffEditor;
        let monacoInstance; // Um 'monaco' global verf√ºgbar zu machen

        // --- Error Modal ---
        function showError(message) {
            errorMessage.textContent = message;
            errorModal.classList.remove('hidden');
        }
        closeModalButton.addEventListener('click', () => {
            errorModal.classList.add('hidden');
        });

        // --- Monaco Editor Initialisierung ---
        require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' }});
        require(['vs/editor/editor.main'], function (monaco) {
            monacoInstance = monaco; // Speichern f√ºr sp√§teren Gebrauch
            
            originalEditor = monaco.editor.create(originalEditorContainer, {
                value: "",
                language: 'html',
                theme: 'vs-dark',
                readOnly: true, 
                minimap: { enabled: false },
                automaticLayout: true
            });

            diffEditor = monaco.editor.createDiffEditor(diffEditorContainer, {
                theme: 'vs-dark',
                readOnly: false, 
                automaticLayout: true,
                minimap: { enabled: false }
            });

            const originalModel = monaco.editor.createModel("", "text/html");
            const modifiedModel = monaco.editor.createModel("", "text/html");
            diffEditor.setModel({
                original: originalModel,
                modified: modifiedModel
            });
            diffEditor.getOriginalEditor().updateOptions({ readOnly: true });
        });

        // --- LocalStorage f√ºr Patch-Anweisungen ---
        changesInput.value = localStorage.getItem('patchInstructions') || '';
        changesInput.addEventListener('input', () => {
            localStorage.setItem('patchInstructions', changesInput.value);
        });

        // --- Datei-Handling (Upload & Drag/Drop) ---
        function handleFile(file) {
            if (!file || !file.type.startsWith('text/html')) {
                showError("Bitte lade eine g√ºltige .html-Datei hoch.");
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                originalContent = e.target.result;
                if (originalEditor) {
                    originalEditor.setValue(originalContent);
                }
                if (diffEditor && monacoInstance) {
                     const originalModel = monacoInstance.editor.createModel(originalContent, "text/html");
                     const modifiedModel = monacoInstance.editor.createModel(originalContent, "text/html");
                     diffEditor.setModel({ original: originalModel, modified: modifiedModel });
                }
                applyButton.disabled = false;
            };
            reader.readAsText(file);
        }

        fileInput.addEventListener('change', (event) => {
            handleFile(event.target.files[0]);
        });

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault(); 
            dropZone.classList.add('drag-over');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) {
                fileInput.files = e.dataTransfer.files; 
                handleFile(e.dataTransfer.files[0]);
            }
        });

        // --- Patch-Logik ---
        applyButton.addEventListener('click', () => {
            const patchText = changesInput.value;
            if (!originalContent || !patchText) {
                showError("Bitte lade eine Datei hoch und gib √Ñnderungsanweisungen ein.");
                return;
            }
            try {
                const modifiedContent = applyPatch(originalContent, patchText);
                
                if (diffEditor && monacoInstance) {
                    const originalModel = monacoInstance.editor.createModel(originalContent, "text/html");
                    const modifiedModel = monacoInstance.editor.createModel(modifiedContent, "text/html");
                    diffEditor.setModel({
                        original: originalModel,
                        modified: modifiedModel
                    });
                }
                
                downloadButton.disabled = false;
            } catch (error) {
                showError("Fehler beim Anwenden der √Ñnderungen:\n" + error.message);
                console.error(error);
            }
        });
        
        // Download-Button
        downloadButton.addEventListener('click', () => {
            if (!diffEditor) return;
            const modifiedContent = diffEditor.getModifiedEditor().getValue();
            if (!modifiedContent) return;

            const blob = new Blob([modifiedContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'modified_page.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        /**
         * Wendet die Patch-Anweisungen auf den Originalinhalt an.
         */
        function applyPatch(originalCode, patchText) {
            let lines = originalCode.split('\n');
            
            const patchCommands = patchText.split('\n')
                .map(cmd => cmd.trim())
                .filter(cmd => cmd !== '' && !cmd.startsWith('#'));
            
            const parsedCommands = patchCommands.map(parseCommand).sort((a, b) => b.lineNumber - a.lineNumber);

            for (const cmd of parsedCommands) {
                const index = cmd.lineNumber - 1; 

                if (index < 0 || index > lines.length) {
                     throw new Error(`Ung√ºltige Zeilennummer in Befehl: "${cmd.original}" (Zeile ${cmd.lineNumber} ist au√üerhalb des Bereichs 1-${lines.length})`);
                }

                switch (cmd.type) {
                    case 'ADD':
                        lines.splice(index, 0, cmd.content);
                        break;
                    case 'DEL':
                        lines.splice(index, 1);
                        break;
                    case 'MOD':
                        if (index >= lines.length) throw new Error(`Zeile ${cmd.lineNumber} existiert nicht zum Modifizieren.`);
                        lines[index] = cmd.content;
                        break;
                    default:
                         throw new Error(`Unbekannter Befehlstyp: "${cmd.original}"`);
                }
            }
            return lines.join('\n');
        }

        /**
         * Parst eine einzelne Befehlszeile.
         */
        function parseCommand(commandLine) {
            const addMatch = commandLine.match(/^ADD\s+(\d+):\s*(.*)$/i);
            if (addMatch) {
                const lineNumber = parseInt(addMatch[1], 10);
                if (Number.isNaN(lineNumber)) throw new Error(`Ung√ºltige Zeilennummer (keine Zahl) in: "${commandLine}"`);
                return { type: 'ADD', lineNumber, content: addMatch[2], original: commandLine };
            }
            const delMatch = commandLine.match(/^DEL\s+(\d+)\s*$/i);
            if (delMatch) {
                const lineNumber = parseInt(delMatch[1], 10);
                if (Number.isNaN(lineNumber)) throw new Error(`Ung√ºltige Zeilennummer (keine Zahl) in: "${commandLine}"`);
                return { type: 'DEL', lineNumber, content: '', original: commandLine };
            }
            const modMatch = commandLine.match(/^MOD\s+(\d+):\s*(.*)$/i);
            if (modMatch) {
                const lineNumber = parseInt(modMatch[1], 10);
                if (Number.isNaN(lineNumber)) throw new Error(`Ung√ºltige Zeilennummer (keine Zahl) in: "${commandLine}"`);
                return { type: 'MOD', lineNumber, content: modMatch[2], original: commandLine };
            }
            throw new Error(`Ung√ºltiges Befehlsformat: "${commandLine}"`);
        }

        // --- NEUE EVENT LISTENER F√úR WORKFLOW TIPP ---

        // Button 1: Original-Code kopieren
        copyOriginalCodeButton.addEventListener('click', () => {
            if (!originalEditor) return;
            const codeToCopy = originalEditor.getValue();
            
            if (codeToCopy) {
                navigator.clipboard.writeText(codeToCopy).then(() => {
                    console.log('Original-Code kopiert!');
                }).catch(err => {
                    console.error('Fehler beim Kopieren', err);
                });
            }
        });

        // Button 2: Patch-Befehl kopieren
        copyPatchCommandButton.addEventListener('click', () => {
            const commandToCopy = patchCommandText.innerText;
            if (commandToCopy) {
                 navigator.clipboard.writeText(commandToCopy).then(() => {
                    console.log('Patch-Befehl kopiert!');
                }).catch(err => {
                    console.error('Fehler beim Kopieren', err);
                });
            }
        });
    </script>
    
    <footer style="text-align:center;padding:1.5rem;background-color:#1f2937;color:#d1d5db;font-size:0.75rem;"><p>Diff & Patch Tool</p><p>Entwickler: Bj√∂rn Voss aka Omega</p><p><a href="mailto:voss.1980@gmail.com" style="color:#3b82f6;text-decoration:none;">voss.1980@gmail.com</a></p></footer>
    
    <button id="installFab" title="App installieren" style="display: none; position: fixed; bottom: 90px; right: 20px; width: 56px; height: 56px; background-color: #1e40af; color: white; border: none; border-radius: 50%; font-size: 24px; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.3); z-index: 1000; justify-content: center; align-items: center;">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
    </button>

    
    <script>
      // --- Service Worker & Update Logik ---
      if ('serviceWorker' in navigator) {
        const repoPath = '/Diff-Patch-Tool/';
        
        navigator.serviceWorker.register('./sw.js', { scope: repoPath })
          .then(registration => {
            console.log('Service Worker registered with scope:', registration.scope);
            
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  const bar = document.getElementById('updateSnackbar');
                  // Null-Pr√ºfung hinzugef√ºgt
                  if (bar) bar.classList.remove('hidden'); 
                  const reloadBtn = document.getElementById('reloadButton');
                  // Null-Pr√ºfung hinzugef√ºgt
                  if (reloadBtn) {
                      reloadBtn.addEventListener('click', () => {
                        // Stelle sicher, dass newWorker noch existiert
                        if (newWorker) {
                            newWorker.postMessage({ type: 'SKIP_WAITING' });
                        }
                      });
                  }
                }
              });
            });
          })
          .catch(err => console.error('SW registration failed:', err));

        let refreshing;
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          if (refreshing) return;
          refreshing = true;
          window.location.reload();
        });
      } else {
         console.log('Service Worker API not supported.');
      }

      // --- Install Button Logik ---
      let deferredPrompt;
      const installButton = document.getElementById('installFab');

      window.addEventListener('beforeinstallprompt', (e) => {
        console.log('beforeinstallprompt event fired');
        e.preventDefault();
        deferredPrompt = e;
        // Null-Pr√ºfung hinzugef√ºgt
        if (installButton) {
          installButton.style.display = 'flex';
        } else {
          console.warn('Install button (installFab) not found when beforeinstallprompt fired.');
        }
      });

      // Null-Pr√ºfung hinzugef√ºgt
      if (installButton) {
        installButton.addEventListener('click', () => { // async entfernt
          console.log('Install button clicked');
          // Zus√§tzliche Null-Pr√ºfung
          if (installButton) {
            installButton.style.display = 'none';
          }
          if (deferredPrompt) {
            deferredPrompt.prompt();
            // Verarbeite das Promise von userChoice
            deferredPrompt.userChoice.then((choiceResult) => {
              console.log('User choice:', choiceResult.outcome);
              deferredPrompt = null; // Setze erst nach der Entscheidung zur√ºck
            }).catch((error) => {
              console.error('Error during userChoice:', error);
              deferredPrompt = null; // Setze auch bei Fehler zur√ºck
            });
          } else {
            console.log('deferredPrompt was null when install button clicked.');
          }
        });
      } else {
          console.warn('Install button (installFab) not found in the DOM.');
      }

      window.addEventListener('appinstalled', () => {
         console.log('PWA wurde installiert (appinstalled event)');
         // Null-Pr√ºfung hinzugef√ºgt
         if (installButton) {
            installButton.style.display = 'none';
         }
        deferredPrompt = null;
      });
    </script>
</body>
</html>
